#!/bin/bash -x
#SBATCH --nodes=3
#SBATCH --ntasks-per-node=12
#SBATCH --cpus-per-task=2
#SBATCH --output=run.out
#SBATCH --error=run.err
#SBATCH --time=00:05:00
#SBATCH --partition=devel

export LD_PRELOAD=$EBROOTIMKL/mkl/lib/intel64/libmkl_def.so:$EBROOTIMKL/mkl/lib/intel64/libmkl_avx2.so:$EBROOTIMKL/mkl/lib/intel64/libmkl_core.so:$EBROOTIMKL/mkl/lib/intel64/libmkl_intel_lp64.so:$EBROOTIMKL/mkl/lib/intel64/libmkl_intel_thread.so:$EBROOTIMKL/lib/intel64/libiomp5.so

export PATH=/p/project/ccstma/scorep/6.0-trunk-mrobefix_intel-parastation-papi/bin:$PATH
#export PATH=/p/project/ccstma/scorep/5.0-trunk_mprobefix_intel-impi-papi/bin:$PATH
export SCOREP_EXPERIMENT_DIRECTORY=scorep-test-HWT2
export SCOREP_PROFILING_MAX_CALLPATH_DEPTH=90
export SCOREP_ENABLE_TRACING=1
#export SCOREP_TOTAL_MEMORY=64M
#export SCOREP_METRIC_PAPI=PAPI_TOT_INS

export PYTHONPATH=$PYTHONPATH:/p/project/ccstma/cstma000/pySDC_deploy
#export I_MPI_ASYNC_PROGRESS=1
#export I_MPI_ASYNC_PROGRESS_THREADS=1
#export MPIR_CVAR_ASYNC_PROGRESS=1

export HWT=2
export PIN=`./correct_pinning.sh`

echo -e "\n\nDEFAULT PINNING\n---------------------------\n"
srun python run_simple_forcing_benchmark.py -n 6

echo -e "\n\nSOCKET PINNING\n---------------------------\n"
srun --cpu_bind=sockets python run_simple_forcing_benchmark.py -n 6
#srun $PIN python -m scorep --mpp=mpi run_simple_forcing_benchmark.py -n 1

echo -e "\n\nBROEMMEL PINNING\n---------------------------\n"
srun $PIN python run_simple_forcing_benchmark.py -n 6

#srun scout.mpi $SCOREP_EXPERIMENT_DIRECTORY/traces.otf2
touch ready